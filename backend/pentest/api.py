import uuid
import logging
from fastapi import APIRouter, BackgroundTasks, HTTPException
from pydantic import BaseModel
from datetime import datetime

# Local imports
# Adjust relative imports based on how the app is run. 
# If running as module backend.ids.serve.app, we need absolute or relative to that context?
# Actually app.py does sys.path insert. 
# We'll stick to relative imports within the module.
from .scanner_engine import DockerNmapScanner
from .parsers import parse_nmap_xml

router = APIRouter(prefix="/api/pentest", tags=["Pentest"])
logger = logging.getLogger(__name__)

# In-memory storage for now (will replace with DB in Phase 6)
SCAN_RESULTS = {}

class ScanRequest(BaseModel):
    target: str
    scan_type: str = "quick" # quick, full, stealth

class ScanResponse(BaseModel):
    scan_id: str
    status: str

def run_background_scan(scan_id: str, target: str, scan_type: str):
    """
    Background task to execute the scan engine.
    """
    logger.info(f"Starting background scan {scan_id} for {target}")
    SCAN_RESULTS[scan_id]["status"] = "running"
    try:
        # Blocks until docker container finishes
        raw_xml = DockerNmapScanner.run_scan(target, scan_type)
        
        # Parse output
        parsed_result = parse_nmap_xml(raw_xml)
        
        SCAN_RESULTS[scan_id]["status"] = "completed"
        SCAN_RESULTS[scan_id]["completed_at"] = datetime.now().isoformat()
        SCAN_RESULTS[scan_id]["result"] = parsed_result
        logger.info(f"Scan {scan_id} completed successfully")
        
    except Exception as e:
        logger.error(f"Scan {scan_id} failed: {e}")
        SCAN_RESULTS[scan_id]["status"] = "failed"
        SCAN_RESULTS[scan_id]["error"] = str(e)

@router.post("/scan", response_model=ScanResponse)
async def start_scan(request: ScanRequest, background_tasks: BackgroundTasks):
    """
    Trigger a new pentest scan.
    """
    scan_id = str(uuid.uuid4())
    
    SCAN_RESULTS[scan_id] = {
        "id": scan_id,
        "target": request.target,
        "type": request.scan_type,
        "status": "pending",
        "created_at": datetime.now().isoformat()
    }
    
    background_tasks.add_task(run_background_scan, scan_id, request.target, request.scan_type)
    
    return {"scan_id": scan_id, "status": "pending"}

@router.get("/results/{scan_id}")
async def get_scan_results(scan_id: str):
    """
    Get the status/results of a specific scan.
    """
    if scan_id not in SCAN_RESULTS:
        raise HTTPException(status_code=404, detail="Scan not found")
    return SCAN_RESULTS[scan_id]

@router.get("/history")
async def get_scan_history():
    """
    Get a list of all recent scans.
    """
    # Sort by created_at desc
    sorted_scans = sorted(
        list(SCAN_RESULTS.values()), 
        key=lambda x: x["created_at"], 
        reverse=True
    )
    return sorted_scans
