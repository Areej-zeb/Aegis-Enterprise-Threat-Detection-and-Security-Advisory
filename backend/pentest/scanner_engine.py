import subprocess
import logging
import os
from typing import Optional

logger = logging.getLogger(__name__)

class DockerNmapScanner:
    IMAGE_NAME = "aegis-nmap-scanner"
    DOCKERFILE_PATH = os.path.join(os.path.dirname(__file__), "Dockerfile")

    @classmethod
    def ensure_image_exists(cls):
        """Builds the Nmap docker image if it doesn't exist."""
        try:
            # Check if image exists
            subprocess.run(
                ["docker", "image", "inspect", cls.IMAGE_NAME],
                check=True,
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL
            )
        except subprocess.CalledProcessError:
            logger.info(f"Building Docker image {cls.IMAGE_NAME}...")
            try:
                subprocess.run(
                    ["docker", "build", "-t", cls.IMAGE_NAME, "-f", cls.DOCKERFILE_PATH, os.path.dirname(cls.DOCKERFILE_PATH)],
                    check=True,
                    capture_output=True
                )
                logger.info(f"Docker image {cls.IMAGE_NAME} built successfully.")
            except subprocess.CalledProcessError as e:
                logger.error(f"Failed to build Docker image: {e.stderr}")
                raise Exception(f"Failed to build scanner image: {e.stderr}")

    @classmethod
    def run_scan(cls, target: str, scan_type: str = "quick") -> str:
        """
        Runs an Nmap scan against the target using the Docker container.
        Returns the raw XML output.
        """
        # Ensure image is ready
        cls.ensure_image_exists()

        flags = ["-oX", "-"] # Output XML to stdout
        
        if scan_type == "quick":
            flags.extend(["-F", "-T4"]) # Fast mode, top 100 ports
        elif scan_type == "full":
            flags.extend(["-p-", "-sV", "-T4"]) # All ports, service version
        elif scan_type == "service":
            flags.extend(["-sV", "--version-intensity", "5"]) # Service detection
        elif scan_type == "stealth":
            flags.extend(["-sS", "-T2"]) 
        else:
            flags.extend(["-F"]) # Default

        # Add target
        flags.append(target)

        # Note: --network host might be needed for some environments, 
        # but isolation is safer. We'll stick to default bridge for now unless target is localhost.
        # If target is localhost/127.0.0.1, it refers to the container itself.
        # To scan the host from container is tricky on Mac/Windows (host.docker.internal).
        # On Linux --network host works best.
        
        docker_args = ["docker", "run", "--rm"]
        
        # Determine if we need host networking (simplified logic)
        # For WSL2/Linux, --network host is often good for scanning the LAN
        docker_args.extend(["--network", "host"]) 
        
        docker_args.append(cls.IMAGE_NAME)
        docker_args.extend(flags)
        
        logger.info(f"Running scan on {target} with type {scan_type}")
        try:
            result = subprocess.run(
                docker_args, 
                capture_output=True, 
                text=True,
                check=True
            )
            return result.stdout
        except subprocess.CalledProcessError as e:
            logger.error(f"Nmap scan failed: {e.stderr}")
            raise Exception(f"Scan failed details: {e.stderr}")
