import xml.etree.ElementTree as ET
import logging
from typing import Dict, Any, List

logger = logging.getLogger(__name__)

def parse_nmap_xml(xml_content: str) -> Dict[str, Any]:
    """
    Parses Nmap XML output into a standardized JSON structure.
    """
    try:
        root = ET.fromstring(xml_content)
        
        result = {
            "hosts": []
        }
        
        for host in root.findall("host"):
            host_data = {
                "ip": "",
                "status": "down",
                "ports": []
            }
            
            # Get IP address
            address = host.find("address[@addrtype='ipv4']")
            if address is not None:
                host_data["ip"] = address.get("addr")
            
            # Get status
            status = host.find("status")
            if status is not None:
                host_data["status"] = status.get("state")
            
            # Get ports
            ports = host.find("ports")
            if ports is not None:
                for port in ports.findall("port"):
                    port_id = port.get("portid")
                    protocol = port.get("protocol")
                    
                    state_elem = port.find("state")
                    state = state_elem.get("state") if state_elem is not None else "unknown"
                    
                    service_elem = port.find("service")
                    service_name = service_elem.get("name") if service_elem is not None else "unknown"
                    version = service_elem.get("version") if service_elem is not None else ""
                    product = service_elem.get("product") if service_elem is not None else ""
                    
                    full_version = f"{product} {version}".strip()
                    
                    if state == "open":
                        host_data["ports"].append({
                            "port": int(port_id),
                            "protocol": protocol,
                            "state": state,
                            "service": service_name,
                            "product": product,
                            "version": version, # Raw version e.g. "2.3.4"
                            "full_version": full_version
                        })
            
            result["hosts"].append(host_data)
            
        return result
        
    except ET.ParseError as e:
        logger.error(f"Failed to parse Nmap XML: {e}")
        return {"error": "Invalid XML format", "details": str(e)}
    except Exception as e:
        logger.error(f"Error parsing scan results: {e}")
        return {"error": "Parsing failed", "details": str(e)}
