import React, { useState, useEffect } from "react";
import {
    Shield,
    Play,
    AlertTriangle,
    ChevronDown,
    ChevronUp,
    Search,
    Server,
    Activity
} from "lucide-react";
import { getPentestHistory, runPentest } from "../api/aegisClient";
import { StatusPill, SeverityBadge } from "../components/common";

function PentestPage() {
    const [targetIp, setTargetIp] = useState("");
    const [scans, setScans] = useState([]);
    const [loading, setLoading] = useState(true);
    const [expandedScanId, setExpandedScanId] = useState(null);
    const [isScanning, setIsScanning] = useState(false);

    useEffect(() => {
        loadScans();
        // Poll for updates every 5 seconds
        const interval = setInterval(loadScans, 5000);
        return () => clearInterval(interval);
    }, []);

    const loadScans = async () => {
        try {
            const history = await getPentestHistory();
            setScans(history);
            setLoading(false);
        } catch (error) {
            console.error("Failed to load scans", error);
            setLoading(false);
        }
    };

    const handleStartScan = async (type = "quick") => {
        if (!targetIp) {
            alert("Please enter a target IP or Hostname");
            return;
        }

        setIsScanning(true);
        try {
            await runPentest(targetIp, type);
            setTargetIp("");
            // Immediate reload to show pending scan
            loadScans();
        } catch (error) {
            alert("Scan failed to start: " + error.message);
        } finally {
            setIsScanning(false);
        }
    };

    return (
        <div className="aegis-page">
            <header className="aegis-dash-header">
                <div>
                    <h1 className="aegis-dash-title">Network Pentesting</h1>
                    <p className="aegis-dash-subtitle">
                        On-demand vulnerability scanning and risk assessment.
                    </p>
                </div>
            </header>

            <section className="aegis-dash-main-grid" style={{ gridTemplateColumns: "1fr" }}>

                {/* Scanner Control Card */}
                <div className="aegis-card">
                    <div className="aegis-card-header">
                        <h2>New Scan</h2>
                    </div>
                    <div className="p-6 flex flex-col md:flex-row gap-4 items-end">
                        <div className="flex-1 w-full">
                            <label className="block text-xs font-medium text-gray-400 mb-1">Target Host / IP</label>
                            <div className="relative">
                                <Search className="absolute left-3 top-2.5 text-gray-500" size={16} />
                                <input
                                    type="text"
                                    value={targetIp}
                                    onChange={(e) => setTargetIp(e.target.value)}
                                    placeholder="e.g., 192.168.1.5 or scanme.nmap.org"
                                    className="w-full bg-gray-900/50 border border-gray-700 rounded pl-10 pr-4 py-2 text-white focus:border-blue-500 outline-none transition-colors"
                                />
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button
                                onClick={() => handleStartScan("quick")}
                                disabled={isScanning}
                                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-medium transition-colors disabled:opacity-50"
                                style={{ minWidth: '120px', justifyContent: 'center' }}
                            >
                                {isScanning ? <Activity className="animate-spin" size={16} /> : <Play size={16} />}
                                Quick Scan
                            </button>
                            <button
                                onClick={() => handleStartScan("full")}
                                disabled={isScanning}
                                className="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded font-medium transition-colors disabled:opacity-50"
                                style={{ minWidth: '120px', justifyContent: 'center' }}
                            >
                                <Server size={16} />
                                Full Scan
                            </button>
                        </div>
                    </div>
                </div>

                {/* Results Table */}
                <div className="aegis-card">
                    <div className="aegis-card-header">
                        <h2>Scan History</h2>
                    </div>
                    <div className="aegis-table-wrapper">
                        <table className="aegis-table">
                            <thead>
                                <tr>
                                    <th>Scan ID</th>
                                    <th>Target</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Risk Level</th>
                                    <th>Ports</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {scans.length > 0 ? (
                                    scans.map((scan) => (
                                        <React.Fragment key={scan.id}>
                                            <tr
                                                onClick={() => setExpandedScanId(expandedScanId === scan.id ? null : scan.id)}
                                                style={{ cursor: 'pointer', backgroundColor: expandedScanId === scan.id ? 'rgba(255,255,255,0.02)' : 'transparent' }}
                                            >
                                                <td style={{ fontFamily: 'monospace' }}>{scan.id.substring(0, 8)}</td>
                                                <td>{scan.target}</td>
                                                <td style={{ textTransform: 'capitalize' }}>{scan.type}</td>
                                                <td>
                                                    <StatusPill status={scan.status} />
                                                </td>
                                                <td>
                                                    {/* Risk Summary Calculation */}
                                                    {(() => {
                                                        if (scan.status !== 'completed' || !scan.result?.hosts?.[0]?.ports) return '-';
                                                        const ports = scan.result.hosts[0].ports;
                                                        let maxScore = 0;
                                                        let kevCount = 0;
                                                        let vulnCount = 0;
                                                        ports.forEach(p => {
                                                            if (p.vulnerabilities) {
                                                                vulnCount += p.vulnerabilities.length;
                                                                p.vulnerabilities.forEach(v => {
                                                                    if (v.severity_score > maxScore) maxScore = v.severity_score;
                                                                    if (v.known_exploited) kevCount++;
                                                                });
                                                            }
                                                        });

                                                        if (kevCount > 0) return <span className="text-red-500 font-bold flex items-center gap-1"><AlertTriangle size={14} /> {kevCount} KEV!</span>;
                                                        if (maxScore >= 9.0) return <span className="text-red-500 font-bold">Critical ({maxScore})</span>;
                                                        if (maxScore >= 7.0) return <span className="text-orange-500 font-bold">High ({maxScore})</span>;
                                                        if (vulnCount > 0) return <span className="text-yellow-500">Medium ({vulnCount})</span>;
                                                        return <span className="text-green-500">Safe</span>;
                                                    })()}
                                                </td>
                                                <td>
                                                    {scan.status === 'completed' && scan.result?.hosts?.[0]?.ports
                                                        ? scan.result.hosts[0].ports.length
                                                        : '-'}
                                                </td>
                                                <td>
                                                    {expandedScanId === scan.id ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                                                </td>
                                            </tr>
                                            {/* Expanded Detail View */}
                                            {expandedScanId === scan.id && scan.result?.hosts?.[0]?.ports && (
                                                <tr>
                                                    <td colSpan={7} style={{ padding: '0', background: 'rgba(0,0,0,0.2)' }}>
                                                        <div style={{ padding: '1rem' }}>
                                                            <h4 className="text-sm font-bold mb-2 text-gray-400">Scan Results Detail ({scan.target})</h4>
                                                            <div className="grid gap-2">
                                                                {scan.result.hosts[0].ports.map((port, idx) => (
                                                                    <div key={idx} className="bg-gray-800/50 p-3 rounded border border-gray-700">
                                                                        <div className="flex justify-between items-center mb-2">
                                                                            <div className="flex items-center gap-2">
                                                                                <span className="font-mono text-blue-400">{port.port}/{port.protocol}</span>
                                                                                <span className="font-semibold">{port.service}</span>
                                                                                {port.product && <span className="text-gray-400 text-sm">({port.product} {port.version})</span>}
                                                                            </div>
                                                                            {port.risk_score ? (
                                                                                <span className={`text-xs px-2 py-0.5 rounded ${port.risk_score >= 9 ? 'bg-red-900/50 text-red-200' : 'bg-gray-700 text-gray-300'}`}>
                                                                                    Risk: {port.risk_score}
                                                                                </span>
                                                                            ) : null}
                                                                        </div>

                                                                        {/* Vulnerabilities List */}
                                                                        {port.vulnerabilities && port.vulnerabilities.length > 0 ? (
                                                                            <div className="mt-2 space-y-1">
                                                                                {port.vulnerabilities.map((vuln, vIdx) => (
                                                                                    <div key={vIdx} className="flex items-start gap-2 text-xs p-1 hover:bg-white/5 rounded">
                                                                                        <SeverityBadge severity={vuln.severity_level} />
                                                                                        <div className="flex-1">
                                                                                            <div className="flex items-center gap-2">
                                                                                                <span className="font-mono font-bold text-gray-300">{vuln.id}</span>
                                                                                                {vuln.known_exploited && (
                                                                                                    <span className="bg-red-600 text-white px-1 rounded text-[10px] uppercase font-bold animate-pulse">
                                                                                                        Exploited in Wild
                                                                                                    </span>
                                                                                                )}
                                                                                                <span className="text-gray-500">CVSS {vuln.severity_score}</span>
                                                                                            </div>
                                                                                            <p className="text-gray-400 line-clamp-1">{vuln.description || "No description available."}</p>
                                                                                        </div>
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        ) : (
                                                                            <div className="text-xs text-green-500/50 italic ml-4">No Known Vulnerabilities</div>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </React.Fragment>
                                    ))
                                ) : (
                                    <tr>
                                        <td colSpan={7} style={{ textAlign: 'center', color: '#888' }}>
                                            No scans performed yet.
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>

            </section>
        </div>
    );
}

export default PentestPage;
