/**
 * Pentest Page
 * Vulnerability scanning with wizard interface
 * Uses DashboardLayout
 */

import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { DashboardLayout } from '@/components/layouts';
import { Button, Card, Input } from '@/components/base';
import { Select, Checkbox, Radio } from '@/components/composite';
import { useWorkflow } from '@/context/WorkflowContext';
import { spacing, colors, typography } from '@/theme/tokens';

type WizardStep = 'target' | 'config' | 'results';

interface ScanResult {
  id: string;
  vulnerability: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  cve?: string;
  description: string;
  remediation: string;
}

/**
 * Pentest Page Component
 * Vulnerability scanning with wizard interface
 */
export const Pentest: React.FC = () => {
  const navigate = useNavigate();
  const { pentestTarget } = useWorkflow();

  const [step, setStep] = useState<WizardStep>('target');
  const [target, setTarget] = useState(pentestTarget || '');
  const [scanType, setScanType] = useState('quick');
  const [schedule, setSchedule] = useState('now');
  const [advancedOptions, setAdvancedOptions] = useState(false);
  const [portRange, setPortRange] = useState('1-1000');
  const [serviceDetection, setServiceDetection] = useState(true);
  const [vulnerabilityChecks, setVulnerabilityChecks] = useState<string[]>(['cve', 'config']);
  const [scanning, setScanning] = useState(false);
  const [scanProgress, setScanProgress] = useState(0);
  const [scanResults, setScanResults] = useState<ScanResult[]>([]);

  const handleStartScan = async () => {
    if (!target) return;

    setStep('results');
    setScanning(true);
    setScanProgress(0);

    // Simulate scan progress
    const interval = setInterval(() => {
      setScanProgress((prev) => {
        if (prev >= 100) {
          clearInterval(interval);
          setScanning(false);
          // Generate mock results
          setScanResults(generateMockResults());
          return 100;
        }
        return prev + Math.random() * 30;
      });
    }, 500);
  };

  const headerActions = (
    <div style={{ display: 'flex', gap: spacing[3], alignItems: 'center' }}>
      <Button variant="secondary" size="md" onClick={() => navigate('/monitor')}>
        Back to Monitor
      </Button>
    </div>
  );

  const sidebar = (
    <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[4] }}>
      <Card elevation="md">
        <Card.Header title="Scan History" />
        <Card.Body>
          <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[3] }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <span style={{ color: colors.text.primary, fontSize: typography.fontSize.sm }}>Last Scan:</span>
              <span style={{ color: colors.primary[500], fontWeight: typography.fontWeight.semibold }}>2 hours ago</span>
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <span style={{ color: colors.text.primary, fontSize: typography.fontSize.sm }}>Total Scans:</span>
              <span style={{ color: colors.primary[500], fontWeight: typography.fontWeight.semibold }}>24</span>
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <span style={{ color: colors.text.primary, fontSize: typography.fontSize.sm }}>Vulnerabilities Found:</span>
              <span style={{ color: colors.primary[500], fontWeight: typography.fontWeight.semibold }}>156</span>
            </div>
          </div>
        </Card.Body>
      </Card>

      <Card elevation="md">
        <Card.Header title="Quick Actions" />
        <Card.Body>
          <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[2] }}>
            <Button fullWidth variant="secondary" size="sm" onClick={() => navigate('/analyze')}>
              View Analysis
            </Button>
            <Button fullWidth variant="secondary" size="sm" onClick={() => navigate('/assistant')}>
              Ask AI
            </Button>
            <Button fullWidth variant="secondary" size="sm">
              Export Report
            </Button>
          </div>
        </Card.Body>
      </Card>
    </div>
  );

  return (
    <DashboardLayout
      title="Vulnerability Scanning"
      subtitle="Pentest & Security Assessment"
      sidebar={sidebar}
      headerActions={headerActions}
      collapsibleSidebar
    >
      <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[4] }}>
        {/* Step 1: Target Selection */}
        {step === 'target' && (
          <Card elevation="md">
            <Card.Header title="Step 1: Target Selection" />
            <Card.Body>
              <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[4] }}>
                <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[2] }}>
                  <label style={{ color: colors.text.primary, fontWeight: typography.fontWeight.semibold, fontSize: typography.fontSize.sm }}>Target IP or Hostname</label>
                  <Input
                    placeholder="e.g., 192.168.1.100 or example.com"
                    value={target}
                    onChange={(e) => setTarget(e.target.value)}
                    size="md"
                  />
                </div>

                <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[2] }}>
                  <label style={{ color: colors.text.primary, fontWeight: typography.fontWeight.semibold, fontSize: typography.fontSize.sm }}>Scan Type</label>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[2] }}>
                    <Radio
                      name="scanType"
                      value="quick"
                      label="Quick Scan (5-10 min)"
                      checked={scanType === 'quick'}
                      onChange={() => setScanType('quick')}
                    />
                    <Radio
                      name="scanType"
                      value="full"
                      label="Full Scan (30-60 min)"
                      checked={scanType === 'full'}
                      onChange={() => setScanType('full')}
                    />
                    <Radio
                      name="scanType"
                      value="stealth"
                      label="Stealth Scan (60+ min)"
                      checked={scanType === 'stealth'}
                      onChange={() => setScanType('stealth')}
                    />
                  </div>
                </div>

                <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[2] }}>
                  <label style={{ color: colors.text.primary, fontWeight: typography.fontWeight.semibold, fontSize: typography.fontSize.sm }}>Schedule</label>
                  <Select
                    options={[
                      { value: 'now', label: 'Run Now' },
                      { value: 'scheduled', label: 'Schedule for Later' },
                      { value: 'recurring', label: 'Recurring Scan' },
                    ]}
                    value={schedule}
                    onChange={(value: string) => setSchedule(value)}
                    size="md"
                  />
                </div>

                <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[2] }}>
                  <Checkbox
                    label="Show Advanced Options"
                    checked={advancedOptions}
                    onChange={setAdvancedOptions}
                  />
                </div>

                {advancedOptions && (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[3], padding: spacing[3], backgroundColor: colors.bg.secondary, borderRadius: '4px' }}>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[2] }}>
                      <label style={{ color: colors.text.primary, fontWeight: typography.fontWeight.semibold, fontSize: typography.fontSize.sm }}>Port Range</label>
                      <Input
                        placeholder="e.g., 1-1000 or 80,443,8080"
                        value={portRange}
                        onChange={(e) => setPortRange(e.target.value)}
                        size="md"
                      />
                    </div>

                    <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[2] }}>
                      <Checkbox
                        label="Enable Service Detection"
                        checked={serviceDetection}
                        onChange={setServiceDetection}
                      />
                    </div>
                  </div>
                )}

                <div style={{ display: 'flex', gap: spacing[3], justifyContent: 'flex-end' }}>
                  <Button variant="secondary" onClick={() => navigate('/monitor')}>
                    Cancel
                  </Button>
                  <Button
                    variant="primary"
                    onClick={() => setStep('config')}
                    disabled={!target}
                  >
                    Next: Configure
                  </Button>
                </div>
              </div>
            </Card.Body>
          </Card>
        )}

        {/* Step 2: Scan Configuration */}
        {step === 'config' && (
          <Card elevation="md">
            <Card.Header title="Step 2: Scan Configuration" />
            <Card.Body>
              <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[4] }}>
                <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[2], padding: spacing[3], backgroundColor: colors.bg.secondary, borderRadius: '4px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ color: colors.text.primary, fontWeight: typography.fontWeight.semibold }}>Target:</span>
                    <code style={{ color: colors.primary[500], fontFamily: 'monospace', fontSize: typography.fontSize.sm }}>{target}</code>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ color: colors.text.primary, fontWeight: typography.fontWeight.semibold }}>Scan Type:</span>
                    <span style={{ color: colors.primary[500], fontSize: typography.fontSize.sm }}>{scanType}</span>
                  </div>
                </div>

                <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[2] }}>
                  <label style={{ color: colors.text.primary, fontWeight: typography.fontWeight.semibold, fontSize: typography.fontSize.sm }}>Vulnerability Checks</label>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[2] }}>
                    <Checkbox
                      label="CVE Database"
                      checked={vulnerabilityChecks.includes('cve')}
                      onChange={(checked: boolean) => {
                        if (checked) {
                          setVulnerabilityChecks([...vulnerabilityChecks, 'cve']);
                        } else {
                          setVulnerabilityChecks(vulnerabilityChecks.filter((c) => c !== 'cve'));
                        }
                      }}
                    />
                    <Checkbox
                      label="Configuration Issues"
                      checked={vulnerabilityChecks.includes('config')}
                      onChange={(checked: boolean) => {
                        if (checked) {
                          setVulnerabilityChecks([...vulnerabilityChecks, 'config']);
                        } else {
                          setVulnerabilityChecks(vulnerabilityChecks.filter((c) => c !== 'config'));
                        }
                      }}
                    />
                    <Checkbox
                      label="Weak Credentials"
                      checked={vulnerabilityChecks.includes('creds')}
                      onChange={(checked: boolean) => {
                        if (checked) {
                          setVulnerabilityChecks([...vulnerabilityChecks, 'creds']);
                        } else {
                          setVulnerabilityChecks(vulnerabilityChecks.filter((c) => c !== 'creds'));
                        }
                      }}
                    />
                  </div>
                </div>

                <div style={{ display: 'flex', gap: spacing[3], justifyContent: 'flex-end' }}>
                  <Button variant="secondary" onClick={() => setStep('target')}>
                    Back
                  </Button>
                  <Button variant="primary" onClick={handleStartScan}>
                    Start Scan
                  </Button>
                </div>
              </div>
            </Card.Body>
          </Card>
        )}

        {/* Step 3: Results */}
        {step === 'results' && (
          <>
            {scanning && (
              <Card elevation="md">
                <Card.Header title="Scan in Progress" />
                <Card.Body>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[3] }}>
                    <div style={{ width: '100%', height: '8px', backgroundColor: colors.border.primary, borderRadius: '4px', overflow: 'hidden' }}>
                      <div
                        style={{
                          width: `${scanProgress}%`,
                          height: '100%',
                          backgroundColor: colors.primary[500],
                          transition: 'width 0.3s ease',
                        }}
                      />
                    </div>
                    <div style={{ textAlign: 'center', color: colors.text.primary, fontSize: typography.fontSize.sm }}>
                      {Math.round(scanProgress)}% Complete
                    </div>
                  </div>
                </Card.Body>
              </Card>
            )}

            {!scanning && scanResults.length > 0 && (
              <>
                <Card elevation="md">
                  <Card.Header title="Scan Results" />
                  <Card.Body>
                    <div style={{ display: 'flex', gap: spacing[4], flexWrap: 'wrap' }}>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[1] }}>
                        <span style={{ color: colors.text.primary, fontSize: typography.fontSize.sm }}>Total Vulnerabilities:</span>
                        <span style={{ color: colors.primary[500], fontWeight: typography.fontWeight.bold, fontSize: typography.fontSize.lg }}>{scanResults.length}</span>
                      </div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[1] }}>
                        <span style={{ color: colors.text.primary, fontSize: typography.fontSize.sm }}>Critical:</span>
                        <span style={{ color: colors.critical[600], fontWeight: typography.fontWeight.bold, fontSize: typography.fontSize.lg }}>
                          {scanResults.filter((r) => r.severity === 'critical').length}
                        </span>
                      </div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[1] }}>
                        <span style={{ color: colors.text.primary, fontSize: typography.fontSize.sm }}>High:</span>
                        <span style={{ color: colors.high[600], fontWeight: typography.fontWeight.bold, fontSize: typography.fontSize.lg }}>
                          {scanResults.filter((r) => r.severity === 'high').length}
                        </span>
                      </div>
                    </div>
                  </Card.Body>
                </Card>

                <Card elevation="md">
                  <Card.Header title="Vulnerabilities" />
                  <Card.Body>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: spacing[3] }}>
                      {scanResults.map((result) => (
                        <div key={result.id} style={{ padding: spacing[3], border: `1px solid ${colors.border.primary}`, borderRadius: '4px' }}>
                          <div style={{ display: 'flex', gap: spacing[2], alignItems: 'flex-start', marginBottom: spacing[2] }}>
                            <span
                              style={{
                                padding: `${spacing[1]} ${spacing[2]}`,
                                borderRadius: '4px',
                                fontSize: typography.fontSize.xs,
                                fontWeight: typography.fontWeight.bold,
                                backgroundColor: result.severity === 'critical' ? colors.critical[100] : result.severity === 'high' ? colors.high[100] : result.severity === 'medium' ? colors.medium[100] : colors.success[100],
                                color: result.severity === 'critical' ? colors.critical[700] : result.severity === 'high' ? colors.high[700] : result.severity === 'medium' ? colors.medium[700] : colors.success[700],
                              }}
                            >
                              {result.severity.toUpperCase()}
                            </span>
                            <h4 style={{ color: colors.text.primary, fontWeight: typography.fontWeight.semibold, fontSize: typography.fontSize.lg, margin: 0 }}>{result.vulnerability}</h4>
                            {result.cve && (
                              <code style={{ color: colors.primary[500], fontFamily: 'monospace', fontSize: typography.fontSize.sm, marginLeft: 'auto' }}>{result.cve}</code>
                            )}
                          </div>
                          <p style={{ color: colors.text.primary, fontSize: typography.fontSize.sm, margin: `0 0 ${spacing[2]} 0` }}>{result.description}</p>
                          <div style={{ color: colors.text.primary, fontSize: typography.fontSize.sm }}>
                            <strong>Remediation:</strong> {result.remediation}
                          </div>
                        </div>
                      ))}
                    </div>
                  </Card.Body>
                </Card>

                <div style={{ display: 'flex', gap: spacing[3], justifyContent: 'flex-end' }}>
                  <Button variant="secondary" onClick={() => setStep('target')}>
                    New Scan
                  </Button>
                  <Button variant="secondary" onClick={() => navigate('/analyze')}>
                    Analyze Results
                  </Button>
                  <Button variant="primary" onClick={() => navigate('/assistant')}>
                    Ask AI for Recommendations
                  </Button>
                </div>
              </>
            )}
          </>
        )}
      </div>
    </DashboardLayout>
  );
};

Pentest.displayName = 'Pentest';

// Mock results generator
function generateMockResults(): ScanResult[] {
  const vulnerabilities = [
    {
      vulnerability: 'SQL Injection',
      severity: 'critical' as const,
      cve: 'CVE-2024-1234',
      description: 'Input validation vulnerability in login form',
      remediation: 'Implement parameterized queries and input validation',
    },
    {
      vulnerability: 'Weak SSL/TLS Configuration',
      severity: 'high' as const,
      cve: 'CVE-2024-5678',
      description: 'Server supports deprecated TLS 1.0',
      remediation: 'Disable TLS 1.0 and 1.1, use TLS 1.2 or higher',
    },
    {
      vulnerability: 'Missing Security Headers',
      severity: 'high' as const,
      description: 'X-Frame-Options header not set',
      remediation: 'Add security headers: X-Frame-Options, X-Content-Type-Options, CSP',
    },
    {
      vulnerability: 'Default Credentials',
      severity: 'critical' as const,
      description: 'Admin panel accessible with default username/password',
      remediation: 'Change default credentials immediately',
    },
    {
      vulnerability: 'Outdated Software',
      severity: 'high' as const,
      description: 'Apache 2.4.1 (outdated version)',
      remediation: 'Update to Apache 2.4.58 or latest stable version',
    },
    {
      vulnerability: 'Information Disclosure',
      severity: 'medium' as const,
      description: 'Server version exposed in HTTP headers',
      remediation: 'Configure server to hide version information',
    },
  ];

  return vulnerabilities.map((v, i) => ({
    id: `vuln-${i}`,
    ...v,
  }));
}

export default Pentest;
